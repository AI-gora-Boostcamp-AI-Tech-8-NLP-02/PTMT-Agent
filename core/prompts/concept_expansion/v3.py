from langchain_core.prompts import ChatPromptTemplate

CONCEPT_EXPANSION_PROMPT_V3 = ChatPromptTemplate.from_messages([
    (
        "system",
        "너는 사용자 맞춤 학습 커리큘럼과 개념 구조를 설계하는 전문 AI 리서치 어시스턴트다. "
        "입력된 키워드 그래프를 분석하여 학습 흐름상 누락된 개념이 있는지 판단하고, "
        "필요한 경우에만 새로운 개념을 추가한다. "
        "필요한 경우 제공된 tool(웹 검색)을 활용해 "
        "개념 간 선후관계나 포함 관계를 검증한다. "
        "반드시 지시를 정확히 따르고 JSON 형식으로만 출력해야 한다."
    ),
    (
        "human",
        """
        아래는 현재 학습 키워드 그래프이다.
        이 그래프를 기반으로 학습 흐름을 개선하기 위해
        추가로 필요한 개념이 있는지 판단하라.

        ### 목표 논문
        {paper_info}
        
        ### 사용자 수준
        {user_level}

        ### 이미 사용자가 알고 있는 개념
        {known_concept}

        ### 현재 키워드 그래프 (JSON)
        {keyword_graph}

        ### 개념 확장 요청 이유
        {reason}
        
        ### 보충이 필요한 개념 키워드 ID 리스트
        {keyword_ids}

        ---
        
        ## 사용자 수준별 개념 확장 전략
        ### novice
        - 학습 그래프의 깊이 충분히 확보
        - 목표 논문이 속한 **상위 도메인 또는 큰 범주의 개념을 포함할 수 있다.**
        - 수식, 알고리즘 이전 단계의 **직관적·기초 개념**을 적극적으로 추가하라.
        
        ### intermediate
        - 학습 그래프의 깊이는 **적당한 수준**으로 유지하라.
        - 구현, 수식 이해, 알고리즘 구조 이해에 직접적으로 도움이 되는 개념만 추가하라.
        
        ### master
        - 목표 논문과 직접적인 연관이 없는 상위 도메인/일반 개념은 **절대 추가하지 마라.**
        - 개념은 반드시 **논문 수준의 세부 메커니즘, 이론적 가정, 미묘한 차이**를 다뤄야 한다.
        
        ---
        ## 이미 이미 알고 있는 개념에 대한 규칙
        다음 중 하나라도 해당하면 **절대 노드로 추가하지 마라**.
        - {known_concept}에 포함된 개념과 **동일한 개념**
        - {known_concept}의 **동의어, 약어, 풀네임, 변형 표현**
        - {known_concept}의 **하위 개념**
        
        새로운 개념은 반드시:
        - {known_concept} 없이도 독립적으로 의미를 가지며 목표 논문 이해에 **새로운 정보 증가**를 제공해야 한다.
        
        ---
        ## 공통 규칙
        - 키워드는 영어 단어 또는 짧은 구문으로 작성할 것
        - 이미 그래프에 있는 개념을 단순 일반화한 키워드는 추가하지 마라.
        - 기존 키워드 그래프의 노드와 엣지는 절대 다시 출력하지 마라.
        - 이미 사용자가 알고 있는 개념과 일치하거나 매우 유사한 개념은 절대 출력하지 마라.
        - 새롭게 추가해야 한다고 판단한 개념만 노드로 출력하라.
        - 새 노드는 기존 키워드 또는 논문 또는 새 키워드와의 관계를 나타내는 엣지를 반드시 포함해야 한다.
        - 엣지는 반드시 keyword_id 기반으로 연결하라.
        - 키워드 간 선후 관계 edge를 생성하는 경우 반드시 tool(웹 검색)을 사용하여 개념 간 관계를 검증한 뒤 edge를 생성하라. (키워드 간 선후 관계를 판단한 이유를 reason에 작성한다.)
        -  추가할 개념이 전혀 없다고 판단되면 nodes와 edges를 빈 배열로 출력하라.

        반드시 아래 JSON 형식으로만 출력하라.
        설명, 주석, 마크다운, 코드블록(```)은 절대 포함하지 마라.

        {{
          "expanded_graph": {{
            "nodes": [
              {{
                "keyword_id": string,
                "keyword": string,
              }}
            ],
            "edges": [
              {{
                "start": string,
                "end": string,
                "reason": string
              }}
            ]
          }}
        }}
        """
    )
])
